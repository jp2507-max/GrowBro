---
name: '202'
overview: Bring the app in line with the 2026 Survival Guide standards by removing `react-native` `Modal` usage, replacing ScrollView+map lists with virtualized lists, and making Expo Router routes lean wrappers that import real screens.
todos: []
---

# 2026 Survival Guide refactor plan

**Applied rules** (per your standards): InteractionComponents, ModalsNavigation, ListPerformance, ExpoRouterLeanRoutes.

## Current findings (from repo scan)

- **Interaction components**: ✅ No legacy Touchables in production code. Only `TouchableOpacity` appears in a test mock (`src/components/consent-manager.test.tsx`).
- **`react-native` `Modal` usage (needs migration)**: found in 4 files:
- [`src/components/harvest/harvest-modal.tsx`](src/components/harvest/harvest-modal.tsx)
- [`src/components/settings/mfa-setup-modal.tsx`](src/components/settings/mfa-setup-modal.tsx)
- [`src/components/assessment/retake-guidance-modal.tsx`](src/components/assessment/retake-guidance-modal.tsx)
- [`src/components/playbooks/ai-adjustments-example.tsx`](src/components/playbooks/ai-adjustments-example.tsx) (appears unused; only referenced from a summary doc)
- **ScrollView + `map()` list rendering (needs virtualization)**:
- [`src/app/(app)/calendar.tsx`](<src/app/(app)/calendar.tsx>) renders `pendingTasks.map(...)` and `completedTasks.map(...)` inside a `ScrollView`.
- [`src/app/settings/active-sessions.tsx`](src/app/settings/active-sessions.tsx) renders `sessions.map(...)` inside a `ScrollView`.
- **Lean Routes violation**: Many route files under [`src/app/`](src/app/) contain hooks/state/effects (≥40 files matched `useState/useEffect/...`). Example: [`src/app/(app)/strains/index.tsx`](<src/app/(app)/strains/index.tsx>), [`src/app/(app)/playbooks/index.tsx`](<src/app/(app)/playbooks/index.tsx>), [`src/app/settings/active-sessions.tsx`](src/app/settings/active-sessions.tsx).
- **SafeAreaView wrappers**: used in 11 route files under [`src/app/`](src/app/) (not always wrong, but often redundant around scrollables).

## Refactor strategy (phased, minimal-risk)

### Phase 1 — ~~Establish "Lean Routes" structure~~ (REVERTED)

> **Decision (2024-12-30)**: Reverted the "lean routes" pattern. The ROI was too low for the refactor effort — Expo Router handles logic in route files fine, and the 1:1 mapping between routes and screens made the extra abstraction unnecessary. Screen logic now lives directly in route files under `src/app/`.

- ~~Create `src/screens/` (kebab-case files) and move screen logic out of the first batch of routes~~
- ~~Convert those route files into wrappers only~~

**Files restored to `src/app/`:**

- `src/app/(app)/calendar.tsx`
- `src/app/(app)/assessment/result.tsx`
- `src/app/settings/active-sessions.tsx` (with supporting files in `src/app/settings/components/` and `src/app/settings/hooks/`)
- `src/app/settings/security.tsx`

### Phase 2 — Remove `react-native` `Modal` (per your strictness)

- **Harvest** (currently a controlled `react-native` page sheet):
- Convert to an Expo Router modal route under [`src/app/(modals)/`](<src/app/(modals)/>) (native swipe-to-dismiss).
- Update the trigger in [`src/app/plants/[id].tsx`](src/app/plants/[id].tsx) to `router.push` the modal route instead of `isVisible` state.
- Refactor `HarvestModal` into a screen component (no `visible` prop; dismiss via `router.back()`), and keep the form internals as reusable components.
- **Assessment retake guidance** (already designed as a bottom sheet UI):
- Replace `react-native` `Modal` in [`src/components/assessment/retake-guidance-modal.tsx`](src/components/assessment/retake-guidance-modal.tsx) with the existing bottom-sheet `Modal` from [`src/components/ui/modal.tsx`](src/components/ui/modal.tsx).
- Update usage in [`src/app/(app)/assessment/result.tsx`](<src/app/(app)/assessment/result.tsx>).
- **MFA setup**:
- Replace `react-native` `Modal` in [`src/components/settings/mfa-setup-modal.tsx`](src/components/settings/mfa-setup-modal.tsx) with a native-feeling sheet approach:
- Preferred: a modal route screen (no secrets in URL; the screen performs enrollment + verification internally).
- Acceptable fallback: bottom-sheet `Modal` if you want to keep the flow fully contained in the Security screen.
- **AI adjustments example**:
- Since it appears unused, either move it to a dedicated `examples/` location (so it’s clearly non-production) or update it to not use `react-native` `Modal`.

### Phase 3 — List virtualization + iOS inset behavior

- **Calendar**: Replace the `ScrollView` in [`src/app/(app)/calendar.tsx`](<src/app/(app)/calendar.tsx>) with `FlashList` (or the existing `List` wrapper in [`src/components/ui/list.tsx`](src/components/ui/list.tsx)).
- Use the same “section item” pattern already used by notifications (see `NotificationListView` in [`src/app/notifications/index.tsx`](src/app/notifications/index.tsx)).
- Ensure `contentInsetAdjustmentBehavior="automatic"` on iOS and preserve bottom padding behavior.
- **Active sessions**: Replace `ScrollView` in [`src/app/settings/active-sessions.tsx`](src/app/settings/active-sessions.tsx) with a virtualized list + `ListHeaderComponent` for the copy/actions.

### Phase 4 — Reduce redundant SafeAreaView usage (targeted) ✅ COMPLETED

Refactored 10 screens to use proper inset handling:

- **Playbooks screens** ([playbooks/[id].tsx](<src/app/(app)/playbooks/[id].tsx>), [apply.tsx](<src/app/(app)/playbooks/apply.tsx>), [index.tsx](<src/app/(app)/playbooks/index.tsx>), [community.tsx](<src/app/(app)/playbooks/community.tsx>)):
- Replaced `SafeAreaView` wrapper with `View` + background color
- Scrollables use `contentInsetAdjustmentBehavior="automatic"`
- Fixed footers use `useSafeAreaInsets()` for bottom padding: `paddingBottom: Math.max(insets.bottom, 16)`

- **Nutrient screens** ([nutrient/index.tsx](<src/app/(app)/nutrient/index.tsx>), [add-reading.tsx](<src/app/(app)/nutrient/add-reading.tsx>), [templates/index.tsx](<src/app/(app)/nutrient/templates/index.tsx>), [templates/[id].tsx](<src/app/(app)/nutrient/templates/[id].tsx>)):
- Same pattern: View root, contentInsetAdjustmentBehavior on ScrollView/FlashList
- Fixed footer button areas use `useSafeAreaInsets()`
- Added dark mode color support where missing

- **style.tsx**: Fixed anti-pattern of SafeAreaView _inside_ ScrollView → now View wrapper _outside_ with proper contentInsetAdjustmentBehavior

- **sortable-calendar-test.tsx**: Replaced SafeAreaView with View (test screen)

**Pattern established:**

1. Root `View` with `flex-1` and background color
2. Scrollable with `contentInsetAdjustmentBehavior="automatic"`
3. Fixed footer: `style={{ paddingBottom: Math.max(insets.bottom, 16) }}`

## Notes / risks

- **Navigation-modal migrations**: back behavior and Android hardware back handling must be revalidated.
- **List migration**: sectioned `FlashList` needs stable `keyExtractor`/`getItemType` and good `estimatedItemSize` to avoid jank.
- **MFA flow**: avoid passing secrets in route params; keep sensitive enrollment data inside the modal screen state.
