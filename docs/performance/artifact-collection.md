# Performance Artifact Collection

This guide explains how performance artifacts are collected during CI test runs and how to use them for debugging and analysis.

## Overview

Performance artifact collection is automated in CI and captures:

- **RN Performance JSON**: Frame metrics, TTI, TTFD from `@shopify/react-native-performance`
- **Sentry Trace URLs**: Links to Sentry performance transactions
- **Perfetto Traces**: Android FrameTimeline traces for detailed jank analysis
- **Memory Metrics**: RSS memory usage before/during/after tests

## Artifacts Collected

### 1. RN Performance JSON

**Location**: `performance-artifacts/rn-performance.json`

**Contains**:

- Average FPS
- P95 frame time
- Dropped frames count and percentage
- Jank count
- Render pass count

**Generated by**: App writes to `FileSystem.documentDirectory/performance.json` during test execution

**Collection**: CI pulls from device via `adb pull` (Android) or simulator file system (iOS)

### 2. Sentry Trace URLs

**Location**: `performance-artifacts/artifact-manifest.json` (URLs listed)

**Contains**: Direct links to Sentry performance transactions for:

- App startup
- Navigation transitions
- Scroll operations
- Sync operations
- AI inference

**Generated by**: Sentry event processor captures transaction IDs and generates URLs

**Collection**: App logs URLs to console with `[SENTRY_TRANSACTION_URL]` prefix; CI parses logs

### 3. Perfetto Traces (Android Only)

**Location**: `performance-artifacts/perfetto-trace.pb`

**Contains**:

- Frame timeline data
- CPU scheduling events
- Memory allocation events
- GPU rendering events
- System call traces

**Generated by**: `scripts/ci/perfetto-collector.sh` starts/stops Perfetto during test execution

**Collection**: Automatically pulled from device after test completion

**Viewing**: Upload to [Perfetto UI](https://ui.perfetto.dev)

### 4. Memory Metrics

**Location**: `performance-artifacts/memory-metrics.json`

**Contains**:

- `baselineRSS`: Memory at app start (MB)
- `peakRSS`: Peak memory during test (MB)
- `postGCRSS`: Memory after garbage collection (MB)
- `deltaMB`: Peak increase from baseline
- `postGCDeltaMB`: Post-GC increase from baseline

**Generated by**: Test harness collects via `adb shell dumpsys meminfo` (Android) or Instruments (iOS)

**Collection**: Written to JSON file and copied to artifacts directory

## CI Integration

### Environment Variables

All artifact collection scripts use these environment variables:

```bash
# Required
BUILD_HASH=<git-commit-sha>
PLATFORM=android|ios
DEVICE_MODEL=<device-name>
OS_VERSION=<os-version>
DATASET_SIZE=<test-dataset-size>

# Optional
OUTPUT_DIR=./performance-artifacts
PERFETTO_TRACE_PATH=./perfetto-trace.pb
RN_PERF_JSON_PATH=./rn-performance.json
MEMORY_METRICS_PATH=./memory-metrics.json
SENTRY_ORG=<sentry-org-slug>
SENTRY_PROJECT=<sentry-project-slug>
```

### Workflow Steps

1. **Start Perfetto** (Android only):

   ```bash
   ./scripts/ci/perfetto-collector.sh start
   ```

2. **Run Performance Tests**:

   ```bash
   maestro test .maestro/community/scroll-performance.yaml
   ```

3. **Stop Perfetto**:

   ```bash
   ./scripts/ci/perfetto-collector.sh stop
   ```

4. **Collect RN Performance JSON**:

   ```bash
   adb pull /sdcard/Android/data/com.growbro.app/files/performance.json
   ```

5. **Validate Budgets**:

   ```bash
   node scripts/ci/performance-validation.js
   ```

6. **Collect Artifacts**:

   ```bash
   pnpm tsx scripts/ci/artifact-collector.ts
   ```

7. **Generate Report**:

   ```bash
   pnpm tsx scripts/ci/generate-performance-report.ts
   ```

8. **Upload to GitHub Actions**:
   ```yaml
   - uses: actions/upload-artifact@v4
     with:
       name: performance-artifacts
       path: performance-artifacts/
   ```

## Using Artifacts Locally

### Collect Perfetto Trace

```bash
# Start collection
export PERFETTO_TRACE_PATH=./my-trace.pb
./scripts/ci/perfetto-collector.sh start

# Run your test scenario
# ...

# Stop and pull trace
./scripts/ci/perfetto-collector.sh stop

# View in Perfetto UI
open https://ui.perfetto.dev
# Upload my-trace.pb
```

### Generate Performance Report

```bash
export BUILD_HASH=$(git rev-parse HEAD)
export PLATFORM=android
export DEVICE_MODEL="Pixel 6a"
export OS_VERSION="Android 13"
export DATASET_SIZE=1000
export RN_PERF_JSON_PATH=./rn-performance.json
export MEMORY_METRICS_PATH=./memory-metrics.json

pnpm tsx scripts/ci/generate-performance-report.ts
```

### Collect All Artifacts

```bash
export BUILD_HASH=$(git rev-parse HEAD)
export PLATFORM=android
export DEVICE_MODEL="Pixel 6a"
export OS_VERSION="Android 13"
export DATASET_SIZE=1000
export OUTPUT_DIR=./my-artifacts

pnpm tsx scripts/ci/artifact-collector.ts
```

## Artifact Manifest

Every artifact collection run generates `artifact-manifest.json`:

```json
{
  "timestamp": "2025-01-08T10:30:00.000Z",
  "buildHash": "abc123...",
  "commit": "abc123...",
  "device": "Pixel 6a Emulator",
  "os": "Android 13",
  "platform": "android",
  "datasetSize": 1000,
  "artifactCount": 4,
  "artifacts": [
    {
      "type": "rnperformance",
      "filePath": "performance-artifacts/rn-performance.json",
      "metadata": { ... }
    },
    {
      "type": "perfetto",
      "filePath": "performance-artifacts/perfetto-trace.pb",
      "metadata": { "sizeMB": 12.5, ... }
    },
    {
      "type": "sentry",
      "url": "https://sentry.io/organizations/.../performance/...",
      "metadata": { ... }
    },
    {
      "type": "memory",
      "filePath": "performance-artifacts/memory-metrics.json",
      "metadata": { "deltaMB": 45, ... }
    }
  ]
}
```

## Performance Report

Every run generates `performance-report.json`:

```json
{
  "timestamp": "2025-01-08T10:30:00.000Z",
  "buildHash": "abc123...",
  "commit": "abc123...",
  "device": {
    "name": "Pixel 6a Emulator",
    "platform": "android",
    "version": "Android 13",
    "isPhysical": false
  },
  "datasetSize": 1000,
  "metrics": {
    "frames": {
      "averageFPS": 59.2,
      "p95FrameTime": 15.8,
      "droppedFrames": 12,
      "droppedFramesPct": 0.8,
      "jankCount": 3
    },
    "memory": {
      "baselineRSS": 150,
      "peakRSS": 195,
      "postGCRSS": 158,
      "deltaMB": 45,
      "postGCDeltaMB": 8
    }
  },
  "artifacts": {
    "rnPerformanceJson": "...",
    "perfettoTrace": "...",
    "memoryMetrics": "...",
    "sentryTraceUrls": ["https://..."]
  },
  "passed": true
}
```

## Troubleshooting

### Perfetto Trace Not Collected

**Symptoms**: `perfetto-trace.pb` is missing or empty

**Solutions**:

1. Ensure device is Android 12+ (Perfetto FrameTimeline requires API 31+)
2. Check adb connection: `adb devices`
3. Verify Perfetto is available: `adb shell perfetto --help`
4. Check device storage: `adb shell df /data/misc/perfetto-traces`

### RN Performance JSON Not Found

**Symptoms**: `rn-performance.json` is missing

**Solutions**:

1. Ensure app writes to `FileSystem.documentDirectory/performance.json`
2. Check app has file system permissions
3. Verify path: `adb shell ls /sdcard/Android/data/com.growbro.app/files/`
4. Check app logs for write errors

### Sentry Trace URLs Missing

**Symptoms**: No Sentry URLs in manifest

**Solutions**:

1. Verify Sentry is initialized: check `SENTRY_DSN` environment variable
2. Ensure `enableSentryTraceUrlCapture()` is called after `Sentry.init()`
3. Check console logs for `[SENTRY_TRANSACTION_URL]` entries
4. Verify `SENTRY_ORG` and `SENTRY_PROJECT` environment variables

### Memory Metrics Not Collected

**Symptoms**: `memory-metrics.json` is missing

**Solutions**:

1. Ensure test harness collects memory metrics
2. Check `adb shell dumpsys meminfo <package>` works manually
3. Verify JSON file is written before artifact collection
4. Check file permissions

## Best Practices

1. **Always collect on release builds**: Dev builds have inflated metrics
2. **Use physical devices for Perfetto**: Emulators may have timing artifacts
3. **Collect baseline traces**: Run tests on known-good builds for comparison
4. **Archive artifacts**: Keep 30-day retention for regression analysis
5. **Link to PRs**: Include artifact links in performance regression reports
6. **Automate analysis**: Parse JSON reports in CI for automated alerts

## Related Documentation

- [Performance Testing Guide](./image-optimization-visual-qa.md)
- [Performance Budgets](../../.kiro/specs/21.%20performance-and-reliability/requirements.md)
- [Perfetto UI Documentation](https://perfetto.dev/docs/)
- [Sentry Performance Monitoring](https://docs.sentry.io/product/performance/)
